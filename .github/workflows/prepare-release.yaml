name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      semverType:
        description: 'Which type of semver to release'
        required: true
        type: choice
        options:
          - 'prerelease'
          - 'patch'
          - 'minor'
          - 'major'

jobs:
  # Prepare all the packages for update
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating/updating branches and PRs
      pull-requests: write # Needed for creating PRs
      id-token: write # Keep your existing permissions

    # Make sure we only perform prerelease on next branch and prod on main branch
    if: (github.ref == 'refs/heads/main' && github.event.inputs.semverType != 'prerelease') || (github.ref == 'refs/heads/next' && github.event.inputs.semverType == 'prerelease')

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Using GITHUB_TOKEN makes actions run as github-actions bot

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: NPM Install
        run: npm install

      # Patch please-release with our own version of the prerelease strategy which always just increments the prerelease version
      - name: Patch release-please prerelease versioning strategy
        run: npx patch-package --patch-dir release

      # Run please-release so that it generates a PR which bumps the versions and updates the changelogs
      # The PR can then be reviewed and merged, once merged run the publish action to actually publish the release and npm packages
      - name: Release Please
        id: release_please
        run: |
          CONFIG_FILE=release/release-please-config.${{ github.event.inputs.semverType }}.json
          MANIFEST_FILE=release/release-please-manifest.${{ github.event.inputs.semverType == 'prerelease' && 'prerelease' || 'prod' }}.json
          OUTPUT=$(node_modules/.bin/release-please release-pr --config-file=${CONFIG_FILE} --manifest-file=${MANIFEST_FILE} --repo-url=${{ github.repository }} --target-branch=${{ github.ref_name}} --token=${{ secrets.GITHUB_TOKEN }})

          echo "Release-please output: $OUTPUT"

          # Extract PR number if a PR was created
          if [[ "$OUTPUT" == *"Successfully opened pull request:"* ]]; then
            # Extract PR number using grep and sed
            PR_NUMBER=$(echo "$OUTPUT" | grep -o "Successfully opened pull request: [0-9]\+" | sed 's/Successfully opened pull request: //')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "PR created: $PR_NUMBER"
          else
            echo "No PR was created"
          fi

      # Automatically approve the PR
      - name: Add reviewer to PR
        if: steps.release_please.outputs.pr_number != ''
        run: |
          gh pr review ${{ steps.release_please.outputs.pr_number }} --approve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
